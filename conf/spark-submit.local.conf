# ========================================
#   MODE LOCAL
# ========================================
spark.master                        local[*]
spark.app.config                    /opt/config/application.conf
spark.local.dir                     /tmp/spark-local

# ========================================
#   DRIVER
# ========================================
spark.driver.memory                 4g
spark.driver.extraJavaOptions       -Dfile.encoding=UTF-8 -Dlog4j.configuration=/opt/spark/conf/log4j2.properties

# ========================================
#   EXECUTORS (IGNORÉS EN LOCAL MAIS LAISSÉS À 1)
# ========================================
spark.executor.instances            1
spark.executor.cores                1
spark.executor.memory               4g
spark.executor.memoryOverhead       1g

# ========================================
#   SERIALIZATION
# ========================================
spark.serializer                    org.apache.spark.serializer.KryoSerializer
spark.kryoserializer.buffer         64m
spark.kryoserializer.buffer.max     512m

# ========================================
#   NETWORK & HEARTBEAT
# ========================================
spark.network.timeout               300s
spark.executor.heartbeatInterval    30s

# ========================================
#   ADAPTIVE QUERY EXECUTION (AQE)
# ========================================
spark.sql.adaptive.enabled                           true
spark.sql.adaptive.coalescePartitions.enabled        true
spark.sql.adaptive.localShuffleReader.enabled        true
spark.sql.adaptive.advisoryPartitionSizeInBytes      64MB
spark.sql.adaptive.skewJoin.enabled                  true
spark.sql.adaptive.skewJoin.skewedPartitionFactor    3
spark.sql.adaptive.skewJoin.skewedPartitionThresholdInBytes 32MB

# ========================================
#   SHUFFLE & PARALLÉLISME (RÉDUIT POUR MACHINES LOCALES)
# ========================================
spark.sql.shuffle.partitions         8
spark.default.parallelism            8
spark.shuffle.compress               true
spark.shuffle.spill.compress         true

# ========================================
#   I/O & FORMAT
# ========================================
spark.sql.files.maxRecordsPerFile    250000
spark.sql.autoBroadcastJoinThreshold 20m
spark.sql.join.preferSortMergeJoin   true

# ========================================
#   CACHE IN-MEMORY
# ========================================
spark.sql.inMemoryColumnarStorage.compressed   true
spark.sql.inMemoryColumnarStorage.batchSize    10000